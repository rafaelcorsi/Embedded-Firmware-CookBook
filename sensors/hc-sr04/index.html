


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://rafaelcorsi.github.io/Embedded-Firmware-CookBook/sensors/hc-sr04/">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>HC SR04 - Embedded System - Cook Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hc-sr04" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://rafaelcorsi.github.io/Embedded-Firmware-CookBook/" title="Embedded System - Cook Book" class="md-header-nav__button md-logo" aria-label="Embedded System - Cook Book">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Embedded System - Cook Book
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              HC SR04
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/rafaelcorsi/Embedded-Firmware-CookBook/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Embedded Firmware CookBook
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://rafaelcorsi.github.io/Embedded-Firmware-CookBook/" title="Embedded System - Cook Book" class="md-nav__button md-logo" aria-label="Embedded System - Cook Book">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Embedded System - Cook Book
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/rafaelcorsi/Embedded-Firmware-CookBook/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Embedded Firmware CookBook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Misc
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Misc" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/digital-input-pooling/" title="Digital Input - Pooling" class="md-nav__link">
      Digital Input - Pooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/digital-input-irq/" title="Digital Input - IRQ" class="md-nav__link">
      Digital Input - IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/digital-output/" title="Digital Output" class="md-nav__link">
      Digital Output
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Sensors
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Sensors" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Sensors
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        HC SR04
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="HC SR04" class="md-nav__link md-nav__link--active">
      HC SR04
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    Hardware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware" class="md-nav__link">
    Firmware
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    Hardware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware" class="md-nav__link">
    Firmware
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rafaelcorsi/Embedded-Firmware-CookBook/edit/master/docs-src/sensors/hc-sr04.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="hc-sr04">HC SR04<a class="headerlink" href="#hc-sr04" title="Permanent link">&para;</a></h1>
<p>Ultrasonic sonar distance sensor with resolution from 2 cm to 400 cm with a max accuracy of 3 mm.</p>
<div class="admonition tip">
<p class="admonition-title">Common uses</p>
<ul>
<li>Robotics (object detection, distance calculation)</li>
<li>Presence detection </li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">References</p>
<ul>
<li><img alt="⭐️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2b50.svg" title=":star:" /> <a href="https://cdn.sparkfun.com/datasheets/Sensors/Proximity/HCSR04.pdf">datasheet</a></li>
<li><a href="https://www.sparkfun.com/products/15569">https://www.sparkfun.com/products/15569</a></li>
<li><a href="https://www.adafruit.com/product/3942">https://www.adafruit.com/product/3942</a></li>
<li><a href="https://create.arduino.cc/projecthub/projects/tags/ultrasonic">https://create.arduino.cc/projecthub/projects/tags/ultrasonic</a></li>
</ul>
</div>
<p>When request by the <code>trigger pin</code>, the sensor send a ultrasonic train pulse (8 pulses at 40 Khz) over it speaker and waiting to receive the sound on microphone, the sensor than returns the time that the pulse took to travel on the <code>echo</code> pin, knowing the sound velocity (350 m/s) is possible to calculate the object distance:</p>
<p><span><span class="MathJax_Preview">object distance (m) = time * 350 / 2</span><script type="math/tex">object distance (m) = time * 350 / 2</script></span></p>
<blockquote>
<p>note: The sensor returns the total travel time, so it is necessary to divide the distance by 2.</p>
</blockquote>
<p>The sensor has the fallowing interfaces/pins:</p>
<ul>
<li><strong>VCC</strong>: 5V</li>
<li><strong>GND</strong>: Ground</li>
<li><strong>IN</strong> <code>Trigger</code>: uC sends a 10us pulse to start a new range measurement </li>
<li><strong>OUT</strong> Echo: Is a pulse sent by the sensor that has width proportional to the time </li>
</ul>
<h2 id="hardware">Hardware<a class="headerlink" href="#hardware" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>pin x</strong>: Microcontroller Input</li>
<li><strong>pin y</strong>: Microcontroller Output</li>
</ul>
<p><img alt="" src="../figs/hc-sr04.svg.png" width="500" /></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This sensor has a 5V interface, on this schematic we do a voltage division to reach 3.3V on the input pin, please check you uC values.</p>
</div>
<h2 id="firmware">Firmware<a class="headerlink" href="#firmware" title="Permanent link">&para;</a></h2>
<p>You must configure:</p>
<ul>
<li>The pin that is connected to the <code>Trigger</code> as <strong>digital output</strong> (pin y).</li>
<li>the pin that is connected to the <code>Echo</code> as <strong>digital input</strong> (pin x)</li>
</ul>
<p>There are several ways to interface with this sensor, it can be done only by software or by using time peripherals. Using peripherals to count time allows the firmware to perform more actions besides interact with the sensor and increase system resolution, this is a most go if the system wants to read more than one sensor at the same time. </p>
<div class="tabbed-set" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">bare metal - no extra timer counter</label><div class="tabbed-content">
<ol>
<li>Configure Trigger and Echo pins respective as output and input</li>
<li>Configure core delay function</li>
<li>To start a new measurement generate a 10us pulse on the <code>Trigger</code> pin</li>
<li>Do a while on the <code>Echo</code> pin waiting it to get <code>High</code></li>
<li>Do a while on the <code>Echo</code> pin waiting it to get <code>low</code>:</li>
<li>add a nano seccond delay on the while</li>
<li>count the cycles </li>
<li>With the count we can calculate the time and then the distance</li>
</ol>
<p>Pins used on this example:</p>
<ul>
<li><code>PC8</code>: Trigger</li>
<li><code>PD20</code>: Echo</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Trigger pin</span>
<span class="cp">#define TRIG_PIO      PIOC</span>
<span class="cp">#define TRIG_PIO_ID   ID_PIOC</span>
<span class="cp">#define TRIG_IDX      8</span>
<span class="cp">#define TRIG_IDX_MASK (1 &lt;&lt; TRIG_IDX)</span>

<span class="c1">// Echo pin</span>
<span class="cp">#define ECHO_PIO      PIOD</span>
<span class="cp">#define ECHO_PIO_ID   ID_PIOD</span>
<span class="cp">#define ECHO_IDX      20</span>
<span class="cp">#define ECHO_IDX_MASK (1 &lt;&lt; ECHO_IDX)</span>

<span class="cp">#define SOUND_VEL 350</span>

<span class="kt">void</span> <span class="nf">hcsr04_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{...};</span>

<span class="kt">void</span> <span class="nf">hcsr04_trig</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pio_set</span> <span class="p">(</span><span class="n">TRIG_PIO</span><span class="p">,</span> <span class="n">TRIG_IDX_MASK</span><span class="p">);</span>
    <span class="n">delay_us</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">pio_clear</span> <span class="p">(</span><span class="n">TRIG_PIO</span><span class="p">,</span> <span class="n">TRIG_IDX_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// init system </span>
    <span class="n">sysclk_init</span> <span class="p">();</span>
    <span class="c1">// sensor pins init</span>
    <span class="n">hcsr04_init</span> <span class="p">();</span>    
    <span class="c1">// init delay</span>
    <span class="n">delay_init</span> <span class="p">(</span><span class="n">sysclk_get_cpu_hz</span> <span class="p">());</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
        <span class="c1">// start measurement  </span>
        <span class="n">hcsr04_trig</span><span class="p">();</span>

        <span class="c1">// wait for pulse init</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">pio_get</span> <span class="p">(</span><span class="n">ECHO_PIN</span><span class="p">,</span> <span class="n">PIO_INPUT</span><span class="p">,</span> <span class="n">ECHO_IDX_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

        <span class="c1">// pulse has started</span>
        <span class="n">unit32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">pio_get</span> <span class="p">(</span><span class="n">ECHO_PIN</span><span class="p">,</span> <span class="n">PIO_INPUT</span><span class="p">,</span> <span class="n">ECHO_IDX_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">delay_us</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// delay is microsecond </span>
        <span class="kt">float</span> <span class="n">time</span>  <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="mf">0.0001</span><span class="p">;</span> 
        <span class="kt">uint32_t</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span> <span class="n">SOUND_VEL</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>

        <span class="c1">// delay for a new mes</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Resolution</p>
<p>Usually vendors software framework wouldn't provide software delay for a period less than 
nano second. </p>
<p>The resolution of this code is limited to the <code>delay_us(1)</code> used to calculate 
the pulse time. This implies in a resolution of 17.5 mm in distance that is higher than the resolution
of sensor (3 mm).</p>
<p>Solutions:</p>
<ul>
<li>Use a lower delay (can be done by nasm)</li>
<li>Use systick to calculate time</li>
<li><img alt="⭐️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2b50.svg" title=":star:" /> Use timercounter peripheral to count time </li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">Timeout</p>
<p>This implementation don't have timeout on the echo signal, some time the sensor won`t
generate an echo pulse and that could lead the firmware to be stuck.</p>
<p>Solutions:</p>
<ul>
<li>Add a software timeout on both <code>while</code></li>
<li>Use systick to timeout </li>
<li><img alt="⭐️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2b50.svg" title=":star:" /> Use an RTOS that has timeout mechanisms </li>
</ul>
<p>Example on how to do by software:</p>
<div class="highlight"><pre><span></span><code><span class="gi">+#define TIMEOUT_US 100</span>

// wait for pulse init
<span class="gi">+uint8_t timeout = 0; </span>
<span class="gi">+uint32_t timeout_count = 0;</span>

while (pio_get (ECHO_PIN, PIO_INPUT, ECHO_IDX_MASK) == 0) {
<span class="gi">+    if (timeout_count++ &gt; TIMEOUT_US) {</span>
<span class="gi">+       timeout = 1;</span>
<span class="gi">+       break;  </span>
<span class="gi">+    }</span>
<span class="gi">+    </span>
<span class="gi">+    delay_us(1);</span>
}

<span class="gi">+if (timeout == 0) { </span>
    while (pio_get (ECHO_PIN, PIO_INPUT, ECHO_IDX_MASK) == 1) {
    ....
<span class="gi">+}</span>
</code></pre></div>

</div>
</div>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../misc/digital-output/" title="Digital Output" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Digital Output
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 / Prof. Rafael Corsi / rafael.corsi@insper.edu.br
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>